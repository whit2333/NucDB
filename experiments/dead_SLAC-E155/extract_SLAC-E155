#! /bin/bash

# E155 is the text file from some version of the new HEPDATA site ...
# ... little confusing see http://hepdata.cedar.ac.uk/View/4909437

# These print third line:
# sed '3q;d' E155_g2p_and_g2d.txt ... turns out this is faster -> awk 'NR==3{print;exit}' file

##############################################################
##############################################################
# FILE : E155_g1p_and_g1n.txt 
# Acually just a proton measurment and neutron calculation using 
# the g1d from same exp 
# Script grabs lines after line 23 and before 57
# skipping lines with length < 5
#         x      Q^2     g1p/F1p   Error        g1n/F1n   Errors
#         mean    GeV^2          stat   syst             stat   syst

currentLine=0
sectionNumber=0 
ElectronAngle=0    
IncidentEnergy=0
linesLeft=0
quantityRemainder=-1
quantity=""

exec 3< extractors/SLAC-E155/E155_g1p_and_g1n.txt 
while read <&3 #### LOOP OVER LINES
do  # use $REPLY
  currentLine=`expr ${currentLine} + 1`
  if (("$currentLine" > "23" && "$currentLine" < "57" )) ; then
  set -- $REPLY
  echo $1 $2 $3 $4 $5
  echo "${#REPLY} characters in line"
    if (("${#REPLY}" > 5 )) ; then
### Fill DB entry ###
cmd="INSERT INTO nuclear_data set "
cmd=${cmd}"Qsq=${2},x=${1},g1_over_F1=${3},err_g1_over_F1_stat=${4},err_g1_over_F1_sys=${5},"
cmd=${cmd}"E_incident=48.35,scattering_angle=NULL,"
cmd=${cmd}"A=$1,Z=1,"
cmd=${cmd}"nucleus=\"proton\" ;"
acmd=`echo -e ${cmd} | sed 's/+//g' `
#echo -e "\n\n $acmd \n\n"
mysql nuclearDB -u bjorken -pdrell -N -e"${acmd}"
cmd="INSERT INTO nuclear_data set "
cmd=${cmd}"Qsq=${2},x=${1},g1_over_F1=${6},err_g1_over_F1_stat=${7},err_g1_over_F1_sys=${8},"
cmd=${cmd}"E_incident=48.35,scattering_angle=NULL,"
cmd=${cmd}"A=2,Z=1,"
cmd=${cmd}"nucleus=\"neutron\" ;"
acmd=`echo -e ${cmd} | sed 's/+//g' `
#echo -e "\n\n $acmd \n\n"
mysql nuclearDB -u bjorken -pdrell -N -e"${acmd}"
### Done filling DB  ###
    fi

  fi 
done
exec 3>&-

echo "done First file"

##############################################################
##############################################################
# FILE : E155_g2p_and_g2d.txt
# Table Sequence :  
#  Groups of four tables (A2p,x*G2p,A2d,X*G2d)
#  Alternate between x and <Qsq> 
#  Kinematic Settings:
#  1-8 ( Ebeam = 29.1 GeV , theta_spectrometer = 2.75 deg ) 8 pts
#  9-16 ( Ebeam = 29.1 GeV , theta_spectrometer = 5.5 deg ) 7 pts
#  17-24 ( Ebeam = 29.1 GeV , theta_spectrometer = 10.5 deg ) 5 pts
#  25-32 ( Ebeam = 32.3 GeV , theta_spectrometer = 2.75 deg ) 8 pts 
#  33-40 ( Ebeam = 32.3 GeV , theta_spectrometer = 5.5 deg ) 7 pts
#  41-48 ( Ebeam = 32.3 GeV , theta_spectrometer = 10.5 deg ) 5 pts
#  49-56 ( combined all energies and angles )10 pts
# relying on xl being on the line before data blocks
currentLine=0
sectionNumber=0 
ElectronAngle=0    
IncidentEnergy=0
linesLeft=0
quantityRemainder=-1
quantity=""


exec 3< extractors/SLAC-E155/E155_g2p_and_g2d.txt 
while read <&3 #### LOOP OVER LINES
do  # use $REPLY
  currentLine=`expr ${currentLine} + 1`
  if [ $linesLeft -gt 0 ] ; then
    set -- $REPLY # divides REPLY up among the postions i.e. $1 $2 $3 etc....
### Fill Database ###
    quantityRemainder=`expr $sectionNumber % 4`
case $quantityRemainder in 
1 ) quantity="A2"
    A=1
    Z=1
    Nucleus="proton" ;; 
2 ) quantity="XG2"
 A=1
Z=1
Nucleus="proton" ;; 
3 ) quantity="A2"
 A=2
Z=1
Nucleus="deuteron" ;; 
0 ) quantity="XG2"
 A=2
Z=1
Nucleus="deuteron" ;;  esac

asdf=`echo -e "(${sectionNumber}-1)%8" |bc  `
echo $asdf
    if [ "${asdf}" -ge "4" ] ; then 
echo "burp"
      Qsq=$1
cmd="INSERT INTO nuclear_data set "
cmd=${cmd}"Qsq=${Qsq},"
cmd=${cmd}"E_incident=${IncidentEnergy},scattering_angle=${ElectronAngle},"
cmd=${cmd}"${quantity}=${3},err_${quantity}=${4},A=${A},Z=${Z},"
cmd=${cmd}"nucleus=\"${Nucleus}\" ;"
acmd=`echo -e ${cmd} | sed 's/+//g' `
#echo -e "\n\n $acmd \n\n"
mysql nuclearDB -u bjorken -pdrell -N -e"${acmd}"
    else
      xBjorken=$1
cmd="INSERT INTO nuclear_data set "
cmd=${cmd}"x=${xBjorken},"
cmd=${cmd}"E_incident=${IncidentEnergy},scattering_angle=${ElectronAngle},"
cmd=${cmd}"${quantity}=${3},err_${quantity}=${4},A=${A},Z=${Z},"
cmd=${cmd}"nucleus=\"${Nucleus}\" ;"
acmd=`echo -e ${cmd} | sed 's/+//g' `
#echo -e "\n\n $acmd \n\n"
mysql nuclearDB -u bjorken -pdrell -N -e"${acmd}"
    fi
    echo $1 $2 $3 $4 $5
### Done Database Entry ###
    linesLeft=`expr ${linesLeft} - 1`
  fi  
  ###########################################
  if [ "${REPLY:0:2}" = "xl" ] ; then   
    sectionNumber=`expr ${sectionNumber} + 1`
    if [ $sectionNumber -le 8 ] ; then 
      linesLeft=8
      IncidentEnergy=29.1    
      ElectronAngle=2.75
    elif [ $sectionNumber -le 16  ] ; then  
      linesLeft=7
      IncidentEnergy=29.1    
      ElectronAngle=5.5
    elif [ $sectionNumber -le 24  ] ; then  
      linesLeft=5
      IncidentEnergy=29.1    
      ElectronAngle=10.50
    elif [ $sectionNumber -le 32  ] ; then  
      linesLeft=8
      IncidentEnergy=32.3    
      ElectronAngle=2.75
    elif [ $sectionNumber -le 40  ] ; then  
      linesLeft=7
      IncidentEnergy=32.3
      ElectronAngle=5.5
    elif [ $sectionNumber -le 48  ] ; then  
      linesLeft=5
      IncidentEnergy=32.3
      ElectronAngle=10.5
    elif [ $sectionNumber -le 56  ] ; then  # all pts combined. 
      linesLeft=10
      ElectronAngle=0    
      IncidentEnergy=0
    else 
      linesLeft=0
      ElectronAngle=0    
      IncidentEnergy=0

    fi
  fi
done
exec 3>&-



exit 0
